<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Display</title>
    <style>
        body {
            margin: 0;
            padding: 2vh;
            background: transparent;
            font-family: Arial, sans-serif;
            color: #000;
        }

        .chat-message {
            display: flex;
            align-items: center;
            gap: 2vw;
            padding: 3vh 3vw;
            background: white;
            border-radius: 1vw;
            box-shadow: 0 0.2vw 1vw rgba(0,0,0,0.1);
            animation: fadeInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            will-change: transform, opacity;
        }

        .chat-message__avatar {
            width: clamp(48px, 8vw, 96px);
            height: clamp(48px, 8vw, 96px);
            border-radius: 50%;
            border: 0.3vw solid var(--role-color, #4CAF50);
        }

        .chat-message__content {
            flex-grow: 1;
        }

        .chat-message__content_header {
            display: flex;
            align-items: center;
            gap: 1vw;
            margin-bottom: 1vh;
        }

        .chat-message__author_name {
            color: var(--role-color, #4CAF50);
            font-weight: bold;
            font-size: clamp(16px, 2.5vw, 32px);
        }

        .chat-message__text {
            font-size: clamp(24px, 4vw, 48px);
            word-wrap: break-word;
            line-height: 1.4;
            color: #000;
        }

        .chat-message__text_emote {
            height: 1.2em;
            width: auto;
            vertical-align: middle;
            margin: 0 0.1em;
        }

        /* Platform-specific styles */
        .chat-message_youtube .chat-message__avatar { border-color: var(--role-color, #FF0000); }
        .chat-message_youtube .chat-message__author_name { color: var(--role-color, #CC0000); }
        
        .chat-message_twitch .chat-message__avatar { border-color: var(--role-color, #9146FF); }
        .chat-message_twitch .chat-message__author_name { color: var(--role-color, #7829E1); }
        
        .chat-message_tiktok .chat-message__avatar { border-color: var(--role-color, #00F2EA); }
        .chat-message_tiktok .chat-message__author_name { color: var(--role-color, #00C5BE); }

        /* Role-based colors */
        .chat-message_role-broadcaster {
            --role-color: #FF4B4B;
        }

        .chat-message_role-moderator {
            --role-color: #00A0FF;
        }

        .chat-message_role-subscriber {
            --role-color: #8E44AD;
        }

        .chat-message_role-verified {
            --role-color: #1DB954;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(2vh);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media screen and (max-width: 600px) {
            .chat-message__text_emote {
                height: clamp(24px, 1.2em, 48px);
            }
        }
    </style>
</head>
<body>
    <script>
        let messageContainer = null;
        const evtSource = new EventSource('/sse');
        
        evtSource.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            console.log("SSE message received - Full data:", data);
            console.log("Message type:", data.type);

            // Only handle display and clear_display types
            if (data.type !== 'display' && data.type !== 'clear_display') {
                console.log('Ignoring non-display message type:', data.type);
                return;
            }

            // Handle clear display command
            if (data.type === "clear_display") {
                console.log("Clear display command received");
                if (messageContainer) {
                    console.log("Starting fade out animation");
                    
                    const animation = messageContainer.animate([
                        {
                            opacity: 1,
                            transform: 'translateY(0)'
                        },
                        {
                            opacity: 0,
                            transform: 'translateY(2vh)'
                        }
                    ], {
                        duration: 300,
                        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                        fill: 'forwards'
                    });

                    animation.onfinish = () => {
                        console.log("Animation completed");
                        if (messageContainer && messageContainer.parentNode) {
                            messageContainer.remove();
                            messageContainer = null;
                            console.log("Message container removed");
                        }
                    };
                } else {
                    console.log("No message container to clear");
                }
                return;
            }

            // Handle display message
            const chatMessage = data.message;
            const platform = chatMessage.data.platform;

            // Create a new container for the animation to restart
            const newContainer = document.createElement('div');
            newContainer.id = 'message-container';

            // Get the content for display
            const content = chatMessage.data.content;
            const displayText = typeof content === 'string' 
                ? content 
                : (content.rawHtml || content.formatted || content.raw || '');

            // Get author information
            const author = chatMessage.data.author;
            const authorName = author.display_name || author.username || 'Anonymous';
            const avatarUrl = author.avatar_url || 'default-avatar.png';

            // Create badges HTML
            const badgesHtml = author.badges?.map(badge => 
                `<img class="badge" src="${badge.image_url}" alt="${badge.label}" title="${badge.label}">`
            ).join('') || '';

            // Handle super chat styling
            const isSuperChat = chatMessage.data.metadata?.type === 'super_chat';
            const superChatStyle = isSuperChat 
                ? `background-color: ${chatMessage.data.metadata.monetary_data?.color || '#4CAF50'};`
                : '';

            // Add this function to get role classes
            function getRoleClasses(roles) {
                if (roles.broadcaster) return 'chat-message_role-broadcaster';
                if (roles.moderator) return 'chat-message_role-moderator';
                if (roles.subscriber) return 'chat-message_role-subscriber';
                if (roles.verified) return 'chat-message_role-verified';
                return '';
            }

            // Update the container class assignment
            const roleClass = getRoleClasses(author.roles);
            newContainer.className = `chat-message chat-message_${platform} ${roleClass} ${isSuperChat ? 'chat-message_super' : ''}`;

            // Update the message container
            newContainer.style = superChatStyle;
            newContainer.innerHTML = `
                <img class="chat-message__avatar" src="${avatarUrl}" alt="${authorName}'s avatar">
                <div class="chat-message__content">
                    <div class="chat-message__content_header">
                        <span class="chat-message__author_name">${authorName}</span>
                        ${badgesHtml}
                    </div>
                    <div class="chat-message__text">${displayText}</div>
                </div>
            `;

            // Replace or append the new container
            if (messageContainer) {
                document.body.replaceChild(newContainer, messageContainer);
            } else {
                document.body.appendChild(newContainer);
            }
            
            // Update the container reference
            messageContainer = newContainer;
        };

        evtSource.onerror = (error) => {
            console.error("SSE connection error:", error);
            setTimeout(() => {
                console.log("Attempting to reconnect...");
                evtSource.close();
                location.reload();
            }, 1000);
        };

        evtSource.onopen = () => {
            console.log("SSE connection established");
        };
    </script>
</body>
</html> 