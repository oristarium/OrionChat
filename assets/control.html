<!DOCTYPE html>
<html lang="en">
  <head>
    <title>OrionChat Control</title>
    <link rel="icon" href="icon.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css"
      rel="stylesheet"
    />
    <script type="module" src="js/control/ConnectionManager.js"></script>
    <script type="module" src="js/control/ChatManager.js"></script>
    <script type="module" src="js/control/AvatarManager.js"></script>
    <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
    <!-- Add MicroModal styles -->
    <style>
      .modal {
        display: none;
      }

      .modal.is-open {
        display: block;
      }

      .modal__overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
      }

      .modal__container {
        max-height: 90vh;
        overflow-y: auto;
      }

      .micromodal-slide {
        display: none;
      }

      .micromodal-slide.is-open {
        display: block;
      }

      .micromodal-slide[aria-hidden="false"] .modal__overlay {
        animation: mmfadeIn 0.3s cubic-bezier(0, 0, 0.2, 1);
      }

      .micromodal-slide[aria-hidden="false"] .modal__container {
        animation: mmslideIn 0.3s cubic-bezier(0, 0, 0.2, 1);
      }

      .micromodal-slide[aria-hidden="true"] .modal__overlay {
        animation: mmfadeOut 0.3s cubic-bezier(0, 0, 0.2, 1);
      }

      .micromodal-slide[aria-hidden="true"] .modal__container {
        animation: mmslideOut 0.3s cubic-bezier(0, 0, 0.2, 1);
      }

      .micromodal-slide .modal__container,
      .micromodal-slide .modal__overlay {
        will-change: transform;
      }

      @keyframes mmfadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes mmfadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes mmslideIn {
        from {
          transform: translateY(15%);
        }
        to {
          transform: translateY(0);
        }
      }

      @keyframes mmslideOut {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-10%);
        }
      }

      #livechat-box {
        background-image: url("https://ucarecdn.com/3b48bc49-000f-4254-afc1-da1e6f367bef/-/preview/400x400/");
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
      }
    </style>
  </head>
  <body class="h-screen overflow-hidden max-w-[400px] mx-auto">
    <!-- Main Container -->
    <main id="app" class="h-full flex flex-col py-1">
      <!-- Tabs -->
      <div class="flex gap-2 mb-2">
        <button
          @click="activeTab = 'livechats'"
          class="px-4 py-2 font-medium rounded-lg transition-colors flex-1"
          :class="activeTab === 'livechats' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        >
          Livechats
        </button>
        <button
          @click="activeTab = 'saved'"
          class="px-4 py-2 font-medium rounded-lg transition-colors flex-1"
          :class="activeTab === 'saved' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        >
          Saved
        </button>
        <button
          @click="activeTab = 'avatars'"
          class="px-4 py-2 font-medium rounded-lg transition-colors flex-1"
          :class="activeTab === 'avatars' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
        >
          Avatars
        </button>
      </div>

      <!-- Livechats Tab Content -->
      <div
        v-if="activeTab === 'livechats'"
        class="flex-1 flex flex-col min-h-0"
      >
        <!-- Header with Buttons -->
        <div class="flex justify-end items-center gap-2 mb-2">
          <button
            @click="clearDisplay"
            class="text-xs text-gray-500 px-2 h-8 hover:bg-gray-100 rounded-lg flex items-center justify-center border relative gap-1"
            title="Clear Display"
          >
            <i class="fas fa-times text-sm"></i>
            Clear Display
          </button>
          <button
            @click="clearTTS"
            class="text-xs text-gray-500 px-2 h-8 hover:bg-gray-100 rounded-lg flex items-center justify-center border relative gap-1"
            title="Clear TTS"
          >
            <i class="fas fa-times text-sm"></i>
            Clear TTS
          </button>
          <label
            for="isTTSAll"
            class="h-8 px-2 text-xs text-gray-500 flex items-center gap-1 hover:bg-gray-100 rounded-lg flex ustify-center border relative"
          >
            <input
              type="checkbox"
              id="isTTSAll"
              :checked="isTTSAll"
              @change="toggleTTSAll"
              class="w-4 h-4 rounded-sm border border-gray-300 text-blue-500 focus:ring-blue-500"
            />
            TTS All</label
          >
          <button
            @click="modal.show('modal-connections')"
            class="w-8 h-8 hover:bg-gray-100 rounded-lg flex items-center justify-center border relative"
            title="Manage connections"
          >
            <i class="fas fa-plug text-sm"></i>
            <span
              class="absolute -top-1 -right-1 bg-blue-500 w-4 h-4 flex items-center justify-center rounded-full text-[10px] text-white"
              >{{ activeConnections.length }}</span
            >
          </button>
        </div>

        <section class="flex-1 relative min-h-0">
          <!-- Chat Messages -->
          <div
            ref="chatBox"
            id="livechat-box"
            class="h-full rounded-lg border p-0 overflow-y-auto min-h-0"
            @mouseenter="isPauseAutoScroll = true; console.log('mouse enter')"
          >
            <div
              v-for="message in messages"
              :key="message.message_id"
              class="p-2"
            >
              <div class="flex items-start gap-2">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <i
                      class="text-xs"
                      :class="{
                            'fab fa-youtube text-red-400': message.platform === 'youtube',
                            'fab fa-twitch text-purple-400': message.platform === 'twitch',
                            'fab fa-tiktok text-pink-400': message.platform === 'tiktok'
                        }"
                    ></i>
                    <span
                      class="text-xs font-bold truncate"
                      :class="{
                            'text-red-500': message.data.author.roles.broadcaster,
                            'text-blue-500': message.data.author.roles.moderator && !message.data.author.roles.broadcaster,
                            'text-green-500': message.data.author.roles.subscriber && !message.data.author.roles.moderator && !message.data.author.roles.broadcaster,
                            'text-gray-500': !message.data.author.roles.subscriber && !message.data.author.roles.moderator && !message.data.author.roles.broadcaster
                        }"
                    >
                      {{ message.data.author.display_name }}
                    </span>
                  </div>
                  <div
                    v-html="message.data.content.rawHtml"
                    class="break-words [&_img.emote]:inline-block [&_img.emote]:align-middle [&_img.emote]:h-[1.2em] [&_img.emote]:w-auto"
                  ></div>
                </div>
                <div class="chat-actions flex items-center gap-1">
                  <button
                    @click="sendDisplay(message)"
                    class="text-gray-400 hover:text-gray-300 p-0.5 self-center"
                    title="Display message"
                  >
                    <i class="fas fa-tv text-xs"></i>
                  </button>
                  <button
                    v-if="message.data.content.sanitized"
                    @click="sendTTS(message)"
                    class="text-gray-400 hover:text-gray-300 p-0.5 self-center"
                    title="Text to Speech"
                  >
                    <i class="fas fa-volume-up text-xs"></i>
                  </button>
                  <button
                    @click="saveChat(message)"
                    class="text-gray-400 hover:text-gray-300 p-0.5 self-center"
                    title="Save message"
                  >
                    <i class="fas fa-save text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Scroll to Bottom Button -->
          <button
            @click="scrollToBottom"
            class="text-xs absolute bottom-0 left-1/2 -translate-x-1/2 z-50 flex items-center justify-center text-white w-full h-10 bg-gradient-to-b from-gray-100/0 to-gray-700"
            :class="{
              'opacity-100': isPauseAutoScroll,
              'opacity-0': !isPauseAutoScroll
            }"
            >
            <i class="fas fa-arrow-down mr-1"></i>
            Scroll to Bottom
          </button>
        </section>
      </div>

      <!-- Saved Tab Content -->
      <div v-if="activeTab === 'saved'" class="flex-1 flex flex-col min-h-0">
        <!-- Custom Message Section -->
        <div class="mb-2 rounded-lg border p-3">
          <textarea
            v-model="customMessage"
            placeholder="Type a custom message..."
            class="w-full border rounded p-2 text-sm mb-2 resize-none h-20"
          ></textarea>
          <div class="flex gap-2">
            <button
              @click="sendCustomTTS"
              class="flex-1 hover:bg-gray-100 text-gray-700 hover:text-gray-900 p-2 rounded border text-sm"
            >
              <i class="fas fa-volume-up mr-2"></i>
              Send TTS
            </button>
            <div class="flex-1 flex gap-1">
              <button
                @click="sendCustomDisplay"
                class="flex-1 hover:bg-gray-100 text-gray-700 hover:text-gray-900 p-2 rounded border text-sm"
              >
                <i class="fas fa-tv mr-2"></i>
                Display
              </button>
              <button
                @click="clearDisplay"
                class="hover:bg-gray-100 text-red-400 hover:text-red-500 p-2 rounded border text-sm"
                title="Clear display"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Saved Messages List -->
        <div
          id="savedchat-box"
          class="flex-1 rounded-lg border p-0 overflow-y-auto min-h-0"
        >
          <div
            v-for="message in sortedSavedMessages"
            :key="message.message_id"
            class="savedchat-message p-2"
          >
            <div class="flex items-start gap-2">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <i
                    class="text-xs"
                    :class="{
                            'fab fa-youtube text-red-400': message.platform === 'youtube',
                            'fab fa-twitch text-purple-400': message.platform === 'twitch',
                            'fab fa-tiktok text-pink-400': message.platform === 'tiktok'
                        }"
                  ></i>
                  <span
                    class="text-xs font-bold truncate"
                    :class="{
                            'text-red-500': message.data.author.roles.broadcaster,
                            'text-blue-500': message.data.author.roles.moderator && !message.data.author.roles.broadcaster,
                            'text-green-500': message.data.author.roles.subscriber && !message.data.author.roles.moderator && !message.data.author.roles.broadcaster,
                            'text-gray-500': !message.data.author.roles.subscriber && !message.data.author.roles.moderator && !message.data.author.roles.broadcaster
                        }"
                  >
                    {{ message.data.author.display_name }}
                  </span>
                </div>
                <div
                  v-html="message.data.content.rawHtml"
                  class="break-words [&_img.emote]:inline-block [&_img.emote]:align-middle [&_img.emote]:h-[1.2em] [&_img.emote]:w-auto"
                ></div>
              </div>
              <div class="chat-actions flex items-center gap-1">
                <button
                  @click="sendDisplay(message)"
                  class="text-gray-400 hover:text-gray-300 p-0.5 self-center"
                  title="Display message"
                >
                  <i class="fas fa-tv text-xs"></i>
                </button>
                <button
                  v-if="message.data.content.sanitized"
                  @click="sendTTS(message)"
                  class="text-gray-400 hover:text-gray-300 p-0.5 self-center"
                  title="Text to Speech"
                >
                  <i class="fas fa-volume-up text-xs"></i>
                </button>
                <button
                  @click="removeSaved(message.message_id)"
                  class="text-red-400 hover:text-red-300 p-0.5 self-center"
                  title="Remove from saved"
                >
                  <i class="fas fa-times text-xs"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Avatars Tab Content -->
      <div v-if="activeTab === 'avatars'" class="flex-1 flex flex-col min-h-0">
        <!-- Header with Create Button -->
        <div class="flex justify-end items-center gap-2 mb-2">
          <button
            @click="createNewAvatar"
            class="text-xs text-gray-500 px-2 h-8 hover:bg-gray-100 rounded-lg flex items-center justify-center border relative gap-1"
          >
            <i class="fas fa-plus text-sm"></i>
            New Avatar
          </button>
        </div>

        <!-- Avatars Table -->
        <div class="flex-1 rounded-lg border overflow-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Idle</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Talking</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Voices</th>
                <th class="w-10"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr v-for="avatar in avatars" :key="avatar.id" class="hover:bg-gray-50">
                <td class="px-4 py-2">
                  <img 
                    :src="avatar.states.idle" 
                    class="h-12 w-12 object-contain cursor-pointer hover:opacity-75" 
                    :alt="avatar.name + ' idle'"
                    @click="openAvatarImageModal(avatar, 'idle')" 
                  />
                </td>
                <td class="px-4 py-2">
                  <img 
                    :src="avatar.states.talking" 
                    class="h-12 w-12 object-contain cursor-pointer hover:opacity-75" 
                    :alt="avatar.name + ' talking'"
                    @click="openAvatarImageModal(avatar, 'talking')" 
                  />
                </td>
                <td class="px-4 py-2">
                  <span 
                    class="text-sm cursor-pointer hover:text-blue-500"
                    @click="openVoiceModal(avatar)"
                  >{{ avatar.tts_voices.length }}</span>
                </td>
                <td class="px-4 py-2">
                  <button
                    v-if="!avatar.is_default"
                    @click="deleteAvatar(avatar.id)"
                    class="text-red-400 hover:text-red-500"
                    title="Delete avatar"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Avatar Image Selection Modal -->
      <div class="modal micromodal-slide" id="modal-avatar-image" aria-hidden="true">
        <div class="modal__overlay" tabindex="-1" data-micromodal-close>
          <div
            class="modal__container rounded-lg p-4 w-full max-w-[600px] border bg-white"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-avatar-image-title"
          >
            <header class="flex justify-between items-center mb-4">
              <h2 id="modal-avatar-image-title" class="text-lg font-bold">
                Select {{ selectedImageType === 'idle' ? 'Idle' : 'Talking' }} Image
              </h2>
              <button
                class="text-gray-500 hover:text-gray-700"
                aria-label="Close modal"
                data-micromodal-close
              >
                <i class="fas fa-times"></i>
              </button>
            </header>

            <main id="modal-avatar-image-content" class="space-y-4">
              <!-- Image Upload -->
              <div 
                class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50"
                @click="triggerFileInput"
                @dragover.prevent
                @drop.prevent="handleFileDrop"
              >
                <input
                  type="file"
                  ref="fileInput"
                  class="hidden"
                  accept="image/*"
                  @change="handleFileSelect"
                />
                <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                <p class="text-sm text-gray-500">
                  Click or drag image to upload
                </p>
              </div>

              <!-- Available Images Grid -->
              <div class="grid grid-cols-4 gap-4">
                <div
                  v-for="image in avatarImages"
                  :key="image"
                  class="aspect-square border rounded-lg p-2 cursor-pointer hover:bg-gray-50"
                  :class="{'border-blue-500 bg-blue-50': isSelectedImage(image)}"
                  @click="selectImage(image)"
                >
                  <img
                    :src="image"
                    class="w-full h-full object-contain"
                    :alt="image"
                  />
                </div>
              </div>

              <!-- Footer -->
              <div class="flex justify-end gap-2 pt-4 border-t">
                <button
                  type="button"
                  class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border rounded"
                  data-micromodal-close
                >
                  Cancel
                </button>
                <button
                  @click="applySelectedImage"
                  class="px-4 py-2 text-sm text-white bg-blue-500 hover:bg-blue-600 rounded"
                >
                  Apply
                </button>
              </div>
            </main>
          </div>
        </div>
      </div>

      <!-- Connections Modal -->
      <div
        class="modal micromodal-slide"
        id="modal-connections"
        aria-hidden="true"
      >
        <div class="modal__overlay" tabindex="-1" data-micromodal-close>
          <div
            class="modal__container rounded-lg p-4 w-full max-w-[400px] border bg-white"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-connections-title"
          >
            <header class="flex justify-between items-center mb-2">
              <h2 id="modal-connections-title" class="text-lg font-bold">
                Manage Connections
              </h2>
              <button
                class="text-gray-500 hover:text-gray-700"
                aria-label="Close modal"
                data-micromodal-close
              >
                <i class="fas fa-times"></i>
              </button>
            </header>

            <main id="modal-connections-content">
              <!-- Active Connections -->
              <div class="space-y-2 mb-2">
                <div
                  v-for="conn in savedConnections"
                  :key="conn.id"
                  class="flex items-center gap-2 p-2 rounded border"
                  :class="{
                    'bg-gray-50': conn.status === 'connected',
                    'bg-gray-100': conn.status === 'disconnected',
                    'bg-yellow-50': conn.status === 'connecting',
                    'bg-red-50': conn.status === 'error'
                  }"
                >
                  <i
                    :class="{
                    'fab fa-youtube text-red-400': conn.platform === 'youtube',
                    'fab fa-twitch text-purple-400': conn.platform === 'twitch',
                    'fab fa-tiktok text-pink-400': conn.platform === 'tiktok'
                  }"
                  ></i>
                  <span class="flex-1 truncate text-sm"
                    >{{ conn.identifier }}</span
                  >
                  <span class="text-xs text-gray-500">{{ conn.status }}</span>
                  <div class="flex gap-1">
                    <button
                      @click="refreshChat(conn.id)"
                      class="text-blue-400 hover:text-blue-300 p-1"
                      :disabled="conn.status === 'connecting'"
                    >
                      <i
                        class="fas fa-sync-alt"
                        :class="{ 'animate-spin': conn.status === 'connecting' }"
                      ></i>
                    </button>
                    <button
                      @click="disconnectChat(conn.id)"
                      class="text-red-400 hover:text-red-300 p-1"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- New Connection Form -->
              <div class="border-t pt-4">
                <div class="flex items-center gap-2">
                  <div class="flex border rounded-lg overflow-hidden">
                    <button
                      v-for="platform in ['youtube', 'twitch', 'tiktok']"
                      :key="platform"
                      @click="newConnection.platform = platform"
                      class="p-2 transition-colors"
                      :class="{
                        'bg-gray-100 text-red-400': platform === 'youtube' && newConnection.platform === 'youtube',
                        'bg-gray-100 text-purple-400': platform === 'twitch' && newConnection.platform === 'twitch',
                        'bg-gray-100 text-pink-400': platform === 'tiktok' && newConnection.platform === 'tiktok',
                        'hover:bg-gray-50': newConnection.platform !== platform
                      }"
                    >
                      <i
                        :class="{
                        'fab fa-youtube': platform === 'youtube',
                        'fab fa-twitch': platform === 'twitch',
                        'fab fa-tiktok': platform === 'tiktok'
                      }"
                      ></i>
                    </button>
                  </div>

                  <select
                    v-if="newConnection.platform === 'youtube'"
                    v-model="newConnection.identifierType"
                    class="border rounded p-2 text-sm"
                  >
                    <option value="username">@user</option>
                    <option value="channelId">ID</option>
                    <option value="liveId">Live</option>
                  </select>

                  <div class="flex-1">
                    <input
                      v-model="newConnection.identifier"
                      :placeholder="getPlaceholder"
                      class="w-full border rounded p-2 text-sm"
                    />
                  </div>

                  <button
                    @click="connectNewChat"
                    class="p-2 text-green-500 hover:text-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    :disabled="!newConnection.identifier"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </main>
          </div>
        </div>
      </div>

      <!-- Voice Selection Modal -->
      <div class="modal micromodal-slide" id="modal-voice-selection" aria-hidden="true">
        <div class="modal__overlay" tabindex="-1" data-micromodal-close>
          <div
            class="modal__container rounded-lg p-4 w-full max-w-[400px] border bg-white"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-voice-selection-title"
          >
            <header class="flex justify-between items-center mb-4">
              <div>
                <h2 id="modal-voice-selection-title" class="text-lg font-bold">
                  Select Voices
                </h2>
              </div>
              <button
                class="text-gray-500 hover:text-gray-700"
                aria-label="Close modal"
                data-micromodal-close
              >
                <i class="fas fa-times"></i>
              </button>
            </header>

            <main id="modal-voice-selection-content" class="space-y-3">
              <!-- Selected Voices -->
              <div v-show="selectedVoices.length > 0" class="space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-xs font-medium text-gray-700">Selected ({{ selectedVoices.length }})</h3>
                  <button
                    @click="clearVoiceSelection"
                    class="text-xs text-gray-500 hover:text-gray-700"
                    title="Clear all"
                  >
                    Clear
                  </button>
                </div>
                <div class="flex flex-wrap gap-1">
                  <div
                    v-for="voice in selectedVoiceDetails"
                    :key="voice.voice_id + voice.provider"
                    class="group flex items-center gap-1 bg-blue-50 text-blue-700 text-xs rounded px-2 py-1"
                  >
                    <i :class="{
                      'fab fa-google text-red-400': voice.provider === 'google',
                      'fab fa-tiktok text-black': voice.provider === 'tiktok'
                    }"></i>
                    <span class="truncate max-w-[150px]" :title="voice.voice_name">{{ voice.voice_name }}</span>
                    <span class="text-blue-400">({{ voice.lang_label }})</span>
                    <button
                      @click="removeVoice(voice)"
                      class="text-blue-400 hover:text-blue-600"
                      title="Remove voice"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Available Voices Section -->
              <div class="space-y-3">
                <h3 class="text-xs font-medium text-gray-700">Available Voices</h3>
                
                <!-- Filters -->
                <div class="space-y-2">
                  <div class="relative">
                    <input
                      v-model="voiceFilters.search"
                      type="text"
                      placeholder="Search voices..."
                      class="w-full border rounded pl-8 pr-2 py-1.5 text-sm"
                    />
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                  </div>
                  <div class="flex gap-1">
                    <select
                      v-model="voiceFilters.provider"
                      class="border rounded py-1 pl-1 pr-5 text-xs"
                    >
                      <option value="">All</option>
                      <option v-for="provider in uniqueProviders" :key="provider" :value="provider">
                        <template v-if="provider === 'google'">Google</template>
                        <template v-else-if="provider === 'tiktok'">TikTok</template>
                      </option>
                    </select>
                    <select
                      v-model="voiceFilters.language"
                      class="border rounded py-1 pl-1 pr-5 text-xs"
                    >
                      <option value="">Lang</option>
                      <option v-for="lang in uniqueLanguages" :key="lang" :value="lang">
                        {{ lang }}
                      </option>
                    </select>
                    <select
                      v-model="voiceFilters.gender"
                      class="border rounded py-1 pl-1 pr-5 text-xs"
                    >
                      <option value="">Gender</option>
                      <option v-for="gender in uniqueGenders" :key="gender" :value="gender">
                        {{ gender }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Available Voices Table -->
                <div class="border rounded overflow-auto max-h-[180px]">
                  <table class="w-full table-fixed">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                      <tr>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 w-[60%]">Name</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 w-[20%]">Lang</th>
                        <th class="w-[20%]"></th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                      <tr
                        v-for="voice in availableVoices"
                        :key="voice.voice_id + voice.provider"
                        class="hover:bg-gray-50"
                      >
                        <td class="px-2 py-1">
                          <div class="flex items-start gap-1 min-w-0">
                            <i :class="{
                              'fab fa-google text-red-400': voice.provider === 'google',
                              'fab fa-tiktok text-black': voice.provider === 'tiktok'
                            }" class="text-xs opacity-50 shrink-0 mt-0.5"></i>
                            <div class="text-xs min-w-0">
                              <div class="break-words flex items-center gap-1">
                                <span>{{ voice.voice_name }}</span>
                                <i v-if="voice.voice_gender !== 'neutral'" :class="{
                                  'fas fa-mars text-blue-400': voice.voice_gender === 'male',
                                  'fas fa-venus text-pink-400': voice.voice_gender === 'female'
                                }" class="text-xs opacity-50"></i>
                              </div>
                            </div>
                          </div>
                        </td>
                        <td class="px-2 py-1 text-xs">{{ voice.lang_label }}</td>
                        <td class="px-2 py-1">
                          <div class="flex items-center justify-end gap-3">
                            <button
                              v-if="voice.sample_voice"
                              @click="playVoiceSample(voice)"
                              class="text-gray-400 hover:text-gray-600 px-1"
                              title="Play sample"
                            >
                              <i class="fas text-xs" :class="isPlayingVoice(voice) ? 'fa-pause' : 'fa-play'"></i>
                            </button>
                            <button
                              @click="addVoice(voice)"
                              class="text-green-500 hover:text-green-600"
                              title="Add voice"
                            >
                              <i class="fas fa-circle-plus text-sm"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Footer -->
              <div class="flex justify-end gap-2 pt-3 border-t">
                <button
                  type="button"
                  class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 border rounded"
                  data-micromodal-close
                  @click="stopVoiceSample"
                >
                  Cancel
                </button>
                <button
                  @click="applyVoiceSelection"
                  class="px-3 py-1.5 text-sm text-white bg-blue-500 hover:bg-blue-600 rounded"
                >
                  Apply
                </button>
              </div>
            </main>
          </div>
        </div>
      </div>

      <div
        class="mt-auto text-center text-xs text-gray-500 w-full grow-0 flex justify-center items-center py-1"
      >
        <span
          >Made with ❤️ by
          <a
            href="https://oristarium.com"
            class="text-blue-500 hover:text-blue-600"
            >Oristarium</a
          ></span
        >
      </div>
    </main>

    <script type="module">
      import { ConnectionManager } from "./js/control/ConnectionManager.js";
      import { ChatManager } from "./js/control/ChatManager.js";
      import { AvatarManager } from "./js/control/AvatarManager.js";

      const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

      const showToast = (message, type = "success") => {
        const colors = {
          success: "linear-gradient(to right, #00b09b, #96c93d)",
          error: "linear-gradient(to right, #ff5f6d, #ffc371)",
          info: "linear-gradient(to right, #2193b0, #6dd5ed)",
        };

        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          style: {
            background: colors[type],
          },
        }).showToast();
      };

      const app = createApp({
        setup() {
          const activeTab = ref("livechats");
          const customMessage = ref("");
          const chatBox = ref(null);
          const lastScrollPosition = ref(0);
          const isPauseAutoScroll = ref(false);
          const isTTSAll = ref(localStorage.getItem('isTTSAll') === 'true');

          // Make MicroModal available to the component
          const modal = {
            show: (modalId) => window.MicroModal.show(modalId),
            close: (modalId) => window.MicroModal.close(modalId),
          };

          // Initialize managers
          const connectionManager = new ConnectionManager();
          const chatManager = new ChatManager();
          const avatarManager = new AvatarManager();

          // Initialize reactive refs
          const activeConnections = ref([]);
          const messages = ref([]);
          const savedMessages = ref([]);
          const savedConnections = ref([]);
          const avatars = ref([]);

          // Initialize on mount
          onMounted(async () => {
            await Promise.all([
              chatManager.init(),
              connectionManager.init(chatManager),
              avatarManager.init(),
            ]);
            // Sync initial isTTSAll state with ChatManager
            chatManager.isTTSAll = isTTSAll.value;
          });

          // Set up callbacks
          connectionManager.showToast = showToast;
          chatManager.showToast = showToast;
          avatarManager.showToast = showToast;

          connectionManager.onConnectionsChange = (connections) => {
            savedConnections.value = connections;
            activeConnections.value = connections.filter(
              (conn) => conn.status === "connected"
            );
          };

          chatManager.onMessagesChange = (newMessages) => {
            messages.value = newMessages;
          };

          chatManager.onSavedMessagesChange = (newMessages) => {
            savedMessages.value = newMessages;
          };

          connectionManager.onMessageReceived = (message) => {
            chatManager.addMessageUnique(message);
            if (isTTSAll.value) {
              sendTTS(message);
            }
            if (!isPauseAutoScroll.value) {
              if (chatBox.value) {
                chatBox.value.scrollTop = chatBox.value.scrollHeight;
              }
            }
          };

          const newConnection = ref({
            platform: "youtube",
            identifierType: "username",
            identifier: "",
          });

          const getPlaceholder = computed(() => {
            if (newConnection.value.platform === "youtube") {
              return newConnection.value.identifierType === "username"
                ? "@username"
                : newConnection.value.identifierType === "channelId"
                ? "Channel ID"
                : "Live ID";
            }
            return "@username";
          });

          const sortedSavedMessages = computed(() => {
            return [...savedMessages.value].sort(
              (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
            );
          });

          // Connect new chat
          const connectNewChat = () => {
            connectionManager.connectNewChat(newConnection.value);
          };

          // Refresh chat
          const refreshChat = (connId) => {
            connectionManager.refreshChat(connId);
          };

          // Disconnect chat
          const disconnectChat = (connId) => {
            connectionManager.disconnectChat(connId);
          };

          // Save chat to favorites
          const saveChat = async (message) => {
            await chatManager.saveMessageToFavorites(message);
          };

          // Remove saved message
          const removeSaved = async (messageId) => {
            await chatManager.removeSavedMessage(messageId);
          };

          // Send TTS
          const sendTTS = async (message) => {
            await chatManager.sendTTS(message);
          };

          // Send Display
          const sendDisplay = async (message) => {
            await chatManager.sendDisplay(message);
          };

          // Send Custom TTS
          const sendCustomTTS = async () => {
            if (await chatManager.sendCustomTTS(customMessage.value)) {
              customMessage.value = "";
            }
          };

          // Send Custom Display
          const sendCustomDisplay = async () => {
            if (await chatManager.sendCustomDisplay(customMessage.value)) {
              customMessage.value = "";
            }
          };

          // Clear Display
          const clearDisplay = () => {
            chatManager.clearDisplay();
            showToast("Display cleared");
          };

          // Clear TTS
          const clearTTS = () => {
            chatManager.clearTTS();
            showToast("TTS cleared");
          };

          // Watch for tab changes
          watch(activeTab, (newTab, oldTab) => {
            if (oldTab === "livechats" && chatBox.value) {
              // Store scroll position when leaving livechats tab
              lastScrollPosition.value = chatBox.value.scrollTop;
            } else if (newTab === "livechats") {
              // Restore scroll position when returning to livechats tab
              nextTick(() => {
                if (chatBox.value) {
                  chatBox.value.scrollTop = lastScrollPosition.value;
                }
              });
            }
          });

          const toggleTTSAll = () => {
            isTTSAll.value = !isTTSAll.value;
            chatManager.isTTSAll = isTTSAll.value;
            localStorage.setItem('isTTSAll', isTTSAll.value);
            showToast(
              "TTS All is now " + (isTTSAll.value ? "enabled" : "disabled"),
              "info"
            );
          };

          const scrollToBottom = () => {
            isPauseAutoScroll.value = false;
            chatBox.value.scrollTop = chatBox.value.scrollHeight;
          };

          avatarManager.onAvatarsChange = (newAvatars) => {
            avatars.value = newAvatars;
          };

          // Create new avatar
          const createNewAvatar = async () => {
            try {
              await avatarManager.createAvatar({});
            } catch (error) {
              console.error('Failed to create avatar:', error);
            }
          };

          // Delete avatar
          const deleteAvatar = async (avatarId) => {
            if (confirm('Are you sure you want to delete this avatar?')) {
              try {
                await avatarManager.deleteAvatar(avatarId);
              } catch (error) {
                console.error('Failed to delete avatar:', error);
              }
            }
          };

          // Avatar image selection
          const fileInput = ref(null);
          const selectedAvatar = ref(null);
          const selectedImageType = ref('idle');
          const selectedImage = ref(null);
          const avatarImages = ref([]);

          // Handle avatar images change
          avatarManager.onAvatarImagesChange = (newImages) => {
            avatarImages.value = newImages;
          };

          const openAvatarImageModal = (avatar, type) => {
            selectedAvatar.value = avatar;
            selectedImageType.value = type;
            selectedImage.value = avatar.states[type];
            modal.show('modal-avatar-image');
          };

          const triggerFileInput = () => {
            fileInput.value.click();
          };

          const handleFileSelect = async (event) => {
            const file = event.target.files[0];
            if (file) {
              try {
                const path = await avatarManager.uploadAvatarImage(file, selectedImageType.value);
                selectImage(path);
              } catch (error) {
                console.error('Failed to upload file:', error);
              }
            }
          };

          const handleFileDrop = async (event) => {
            const file = event.dataTransfer.files[0];
            if (file) {
              try {
                const path = await avatarManager.uploadAvatarImage(file, selectedImageType.value);
                selectImage(path);
              } catch (error) {
                console.error('Failed to upload file:', error);
              }
            }
          };

          const selectImage = (path) => {
            selectedImage.value = path;
          };

          const isSelectedImage = (path) => {
            return selectedImage.value === path;
          };

          const applySelectedImage = async () => {
            if (selectedAvatar.value && selectedImage.value) {
              try {
                const states = {
                  ...selectedAvatar.value.states,
                  [selectedImageType.value]: selectedImage.value
                };
                await avatarManager.updateAvatarState(selectedAvatar.value.id, states);
                modal.close('modal-avatar-image');
              } catch (error) {
                console.error('Failed to update avatar:', error);
              }
            }
          };

          // Voice selection
          const voices = ref([]);
          const selectedVoices = ref([]);
          const voiceFilters = ref({
            search: '',
            provider: '',
            language: '',
            gender: ''
          });

          // Handle voices change
          avatarManager.onVoicesChange = (newVoices) => {
            voices.value = newVoices;
          };

          // Computed properties for filters
          const uniqueProviders = computed(() => 
            [...new Set(voices.value.map(v => v.provider))]
          );

          const uniqueLanguages = computed(() => 
            [...new Set(voices.value.map(v => v.lang_label))]
          );

          const uniqueGenders = computed(() => 
            [...new Set(voices.value.map(v => v.voice_gender))]
          );

          const filteredVoices = computed(() => {
            return voices.value.filter(voice => {
              const matchesSearch = !voiceFilters.value.search || 
                voice.voice_name.toLowerCase().includes(voiceFilters.value.search.toLowerCase());
              const matchesProvider = !voiceFilters.value.provider || 
                voice.provider === voiceFilters.value.provider;
              const matchesLanguage = !voiceFilters.value.language || 
                voice.lang_label === voiceFilters.value.language;
              const matchesGender = !voiceFilters.value.gender || 
                voice.voice_gender === voiceFilters.value.gender;
              
              return matchesSearch && matchesProvider && matchesLanguage && matchesGender;
            });
          });

          const isAllSelected = computed(() => {
            if (!selectedVoices.value || !filteredVoices.value.length) return false;
            
            return filteredVoices.value.every(voice => 
              selectedVoices.value.some(sv => 
                sv.voice_id === voice.voice_id && sv.provider === voice.provider
              )
            );
          });

          const toggleAllVoices = () => {
            if (isAllSelected.value) {
              selectedVoices.value = [];
            } else {
              selectedVoices.value = filteredVoices.value.map(voice => ({
                voice_id: voice.voice_id,
                provider: voice.provider
              }));
            }
          };

          const openVoiceModal = async (avatar) => {
            selectedAvatar.value = avatar;
            try {
              const currentVoices = await avatarManager.getAvatarVoices(avatar.id);
              selectedVoices.value = currentVoices || avatar.tts_voices || [];
            } catch (error) {
              selectedVoices.value = avatar.tts_voices || [];
            }
            modal.show('modal-voice-selection');
          };

          const applyVoiceSelection = async () => {
            if (selectedAvatar.value) {
              try {
                await avatarManager.updateAvatarVoices(selectedAvatar.value.id, selectedVoices.value);
                modal.close('modal-voice-selection');
              } catch (error) {
                console.error('Failed to update voices:', error);
              }
            }
          };

          const isVoiceSelected = (voice) => {
            if (!selectedVoices.value) return false;
            
            return selectedVoices.value.some(sv => 
              sv.voice_id === voice.voice_id && sv.provider === voice.provider
            );
          };

          const clearVoiceSelection = () => {
            selectedVoices.value = [];
          };

          // Computed property for selected voice details
          const selectedVoiceDetails = computed(() => {
            return selectedVoices.value.map(sv => {
              const voice = voices.value.find(v => 
                v.voice_id === sv.voice_id && v.provider === sv.provider
              );
              return voice;
            }).filter(Boolean);
          });

          // Computed property for available voices (excluding selected ones)
          const availableVoices = computed(() => {
            return filteredVoices.value.filter(voice => 
              !selectedVoices.value.some(sv => 
                sv.voice_id === voice.voice_id && sv.provider === voice.provider
              )
            );
          });

          const addVoice = (voice) => {
            // Stop any playing audio
            stopVoiceSample();
            
            selectedVoices.value.push({
              voice_id: voice.voice_id,
              provider: voice.provider
            });
          };

          const removeVoice = (voice) => {
            // Stop any playing audio
            stopVoiceSample();
            
            selectedVoices.value = selectedVoices.value.filter(sv => 
              !(sv.voice_id === voice.voice_id && sv.provider === voice.provider)
            );
          };

          const currentPlayingVoice = ref(null);

          const playVoiceSample = (voice) => {
            if (currentPlayingVoice.value === voice) {
              avatarManager.stopVoiceSample();
              currentPlayingVoice.value = null;
            } else {
              avatarManager.playVoiceSample(voice);
              currentPlayingVoice.value = voice;
              
              // Auto-stop when audio ends
              if (avatarManager.currentAudio) {
                avatarManager.currentAudio.onended = () => {
                  currentPlayingVoice.value = null;
                };
              }
            }
          };

          const stopVoiceSample = () => {
            avatarManager.stopVoiceSample();
            currentPlayingVoice.value = null;
          };

          const isPlayingVoice = (voice) => {
            return currentPlayingVoice.value === voice;
          };

          return {
            activeTab,
            customMessage,
            activeConnections,
            savedConnections,
            newConnection,
            getPlaceholder,
            sortedSavedMessages,
            connectNewChat,
            refreshChat,
            disconnectChat,
            saveChat,
            removeSaved,
            chatBox,
            sendTTS,
            sendDisplay,
            sendCustomTTS,
            sendCustomDisplay,
            clearDisplay,
            clearTTS,
            modal,
            messages,
            isPauseAutoScroll,
            isTTSAll,
            toggleTTSAll,
            scrollToBottom,
            avatars,
            createNewAvatar,
            deleteAvatar,
            fileInput,
            selectedImageType,
            avatarImages,
            openAvatarImageModal,
            triggerFileInput,
            handleFileSelect,
            handleFileDrop,
            selectImage,
            isSelectedImage,
            applySelectedImage,
            voices,
            selectedVoices,
            voiceFilters,
            uniqueProviders,
            uniqueLanguages,
            uniqueGenders,
            filteredVoices,
            isAllSelected,
            toggleAllVoices,
            openVoiceModal,
            applyVoiceSelection,
            isVoiceSelected,
            clearVoiceSelection,
            selectedVoiceDetails,
            availableVoices,
            addVoice,
            removeVoice,
            playVoiceSample,
            stopVoiceSample,
            isPlayingVoice,
          };
        },
      });

      app.mount("#app");
    </script>

    <script>
      MicroModal.init({
        onShow: (modal) => console.log(`${modal.id} is shown`),
        onClose: (modal) => console.log(`${modal.id} is hidden`),
        openTrigger: "data-micromodal-trigger",
        closeTrigger: "data-micromodal-close",
        openClass: "is-open",
        disableScroll: true,
        disableFocus: false,
        awaitOpenAnimation: false,
        awaitCloseAnimation: false,
        debugMode: false,
      });
    </script>
  </body>
</html>
